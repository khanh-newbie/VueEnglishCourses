<template>
  <!-- ========================== -->
  <!-- üü¶ PH·∫¶N 1: SLIDER / HEADER -->
  <!-- ========================== -->
  <!-- Hi·ªÉn th·ªã ti√™u ƒë·ªÅ kh√≥a h·ªçc, breadcrumb, v√† th√¥ng tin gi·∫£ng vi√™n -->
  <div id="slider" class="slider-section text-white overflow-hidden">
    <div class="container py-5">
      <div class="row">
        <div class="col-12">

          <!-- üü® Breadcrumb ƒëi·ªÅu h∆∞·ªõng -->
          <div class="position-absolute top-0 start-0 mt-3 ms-3 text-start">
            <nav aria-label="breadcrumb">
              <ol class="breadcrumb mb-0">
                <li class="breadcrumb-item">
                  <router-link to="/" class="text-white-50 text-decoration-none">Trang ch·ªß</router-link>
                </li>
                <li class="breadcrumb-item">
                  <router-link to="/courses" class="text-white-50 text-decoration-none">Kh√≥a h·ªçc</router-link>
                </li>
                <li class="breadcrumb-item active text-white" aria-current="page">{{ course?.name }}</li>
              </ol>
            </nav>
          </div>

          <!-- üü© Ti√™u ƒë·ªÅ + th√¥ng tin kh√≥a h·ªçc -->
          <div class="container d-flex flex-column align-items-center justify-content-center text-center pt-4">
            <h1 class="fw-bold mb-2 display-5">{{ course?.name }}</h1>
            <p class="mb-1"><i class="bi bi-person-circle me-2"></i>{{ course?.teacher }}</p>
            <p class="mb-0"><i class="bi bi-book me-2"></i>{{ course?.title }}</p>
          </div>
        </div>
      </div>
    </div>

    <!-- üüß Shapes trang tr√≠ -->
    <div class="shape shape-1"></div>
    <div class="shape shape-2"></div>
    <div class="shape shape-3"></div>
  </div>

  <!-- ========================== -->
  <!-- üü© PH·∫¶N 2: N·ªòI DUNG CHI TI·∫æT -->
  <!-- ========================== -->
  <div id="content">

    <!-- üü® KHU V·ª∞C CHI TI·∫æT KH√ìA H·ªåC -->
    <section id="course-detail" class="py-5 bg-light">
      <div class="container">
        <div class="row g-4">

          <!-- ============================= -->
          <!-- üü¶ TR√ÅI: N·ªòI DUNG KH√ìA H·ªåC    -->
          <!-- ============================= -->
          <div class="col-lg-8">

            <!-- Tabs chuy·ªÉn ƒë·ªïi: T·ªïng quan / Ch∆∞∆°ng tr√¨nh / Gi·∫£ng vi√™n -->
            <ul class="nav nav-tabs" id="courseTab" role="tablist">
              <li class="nav-item" role="presentation">
                <button class="nav-link active" id="overview-tab" data-bs-toggle="tab" data-bs-target="#overview" type="button" role="tab">
                  T·ªïng quan
                </button>
              </li>
              <li class="nav-item" role="presentation">
                <button class="nav-link" id="curriculum-tab" data-bs-toggle="tab" data-bs-target="#curriculum" type="button" role="tab">
                  Ch∆∞∆°ng tr√¨nh h·ªçc
                </button>
              </li>
              <li class="nav-item" role="presentation">
                <button class="nav-link" id="instructor-tab" data-bs-toggle="tab" data-bs-target="#instructor" type="button" role="tab">
                  Gi·∫£ng vi√™n
                </button>
              </li>
            </ul>

            <!-- üüß N·ªôi dung t·ª´ng tab -->
            <div class="tab-content mt-3" id="courseTabContent">

              <!-- Tab: T·ªïng quan -->
              <div class="tab-pane fade show active" id="overview" role="tabpanel">
                <h4 class="fw-bold mb-3">T·ªïng quan kh√≥a h·ªçc</h4>
                <p>Kh√≥a h·ªçc Toeic Reading gi√∫p b·∫°n n·∫Øm v·ªØng k·ªπ nƒÉng ƒë·ªçc hi·ªÉu, t·ª´ v·ª±ng v√† chi·∫øn l∆∞·ª£c l√†m b√†i thi hi·ªáu qu·∫£.</p>
              </div>

              <!-- Tab: Ch∆∞∆°ng tr√¨nh h·ªçc -->
              <div class="tab-pane fade" id="curriculum" role="tabpanel">
                <!-- ‚úÖ Import component con hi·ªÉn th·ªã danh s√°ch b√†i h·ªçc -->
                <CourseCurriculum :courseType="slugType" :courseId="course?.slug" />
              </div>

              <!-- Tab: Gi·∫£ng vi√™n -->
              <div class="tab-pane fade" id="instructor" role="tabpanel">
                <div class="d-flex align-items-center mt-3">
                  <img
                    src="https://secure.gravatar.com/avatar/024468074b51259bc54a1458828c56fca665cc3a62ebf983717e2199809060b3?s=150"
                    class="rounded-circle me-3" width="80" height="80" alt="Gi·∫£ng vi√™n">
                  <div>
                    <h5 class="mb-1">{{ course?.teacher }}</h5>
                    <p class="mb-0 text-muted">Gi·∫£ng vi√™n Toeic chuy√™n s√¢u v·ªõi h∆°n 5 nƒÉm kinh nghi·ªám.</p>
                  </div>
                </div>
              </div>
            </div>
          </div>

          <!-- ============================= -->
          <!-- üü® PH·∫¢I: SIDEBAR TH√îNG TIN KH√ìA -->
          <!-- ============================= -->
          <div class="col-lg-4">
            <div class="card shadow-sm">
              <img
                src="https://englishwithhuy.com/wp-content/themes/edublink/assets/images/course-preview.jpg"
                class="card-img-top" alt="Preview">
              <div class="card-body">
                <h5 class="fw-bold">Kho√° h·ªçc bao g·ªìm:</h5>
                <ul class="list-unstyled mb-3">
                  <li><i class="bi bi-cash-coin me-2 text-success"></i><strong>Gi√°:</strong> {{ course?.price }}</li>
                  <li><i class="bi bi-person-fill me-2 text-primary"></i><strong>Gi√°o vi√™n:</strong> {{ course?.teacher }}</li>
                  <li><i class="bi bi-journal-text me-2 text-warning"></i><strong>B√†i h·ªçc:</strong> {{ lessonCount }}</li>
                  <li><i class="bi bi-people-fill me-2 text-info"></i><strong>H·ªçc vi√™n:</strong> {{ course?.students }}</li>
                </ul>
              </div>
            </div>
          </div>
        </div>
      </div>
    </section>
  </div>
</template>

<script>
// ===================================
// üß† PH·∫¶N 3: LOGIC V√Ä D·ªÆ LI·ªÜU KH√ìA H·ªåC
// ===================================
import { courses } from '../data/courses.js'
import CourseCurriculum from "../components/CourseCurriculum.vue"
import lessons from '../data/lesson.json'
import { useCartStore } from '../stores/cartStore.js'
import { useOrderStore } from '../stores/orderStore.js'
import { useUserStore } from '../stores/userStore.js'
import { useNotificationStore } from '../stores/notificationStore.js'

export default {
  name: "CourseDetail",
  components: { CourseCurriculum },
  props: ['slug'],
  data: () => ({
    course: null
  }),

  // üß© Computed: T·ª± x√°c ƒë·ªãnh lo·∫°i kh√≥a h·ªçc t·ª´ slug + ƒë·∫øm s·ªë b√†i h·ªçc
  computed: {
    slugType() {
      if (this.slug?.includes('reading')) return 'reading'
      if (this.slug?.includes('listening')) return 'listening'
      if (this.slug?.includes('speaking')) return 'speaking'
      if (this.slug?.includes('writing')) return 'writing'
      return ''
    },
    lessonCount() {
      return this.slugType ? lessons[this.slugType].length : 0
    }
  },

  // üîÑ Lifecycle
  mounted() {
    this.loadCourse()
  },

  // üîÅ Theo d√µi thay ƒë·ªïi route (slug)
  watch: {
    '$route.params.slug': 'loadCourse'
  },

  // ‚öôÔ∏è C√°c h√†m x·ª≠ l√Ω logic
  methods: {
    // üü¢ T·∫£i th√¥ng tin kh√≥a h·ªçc theo slug
    loadCourse() {
      this.course = courses.find(c => c.slug === this.$route.params.slug)
    },

    // üõí H√†m mua kh√≥a h·ªçc
    buyCourse() {
      const orderStore = useOrderStore()
      const userStore = useUserStore()
      const notify = useNotificationStore()

      if (!userStore.user) {
        notify.show('‚ö†Ô∏è B·∫°n c·∫ßn ƒëƒÉng nh·∫≠p tr∆∞·ªõc khi mua kh√≥a h·ªçc!', 'error')
        return
      }

      orderStore.addOrder({
        id: 'ORD' + Date.now(),
        items: [{ id: this.course.id, title: this.course.name }],
        total: this.course.price,
        userEmail: userStore.user.email,
        createdAt: new Date().toISOString(),
      })

      // C·∫≠p nh·∫≠t purchasedCourses reactive
      if (!userStore.user.purchasedCourses.includes(this.course.slug)) {
        userStore.purchaseCourse(this.course.slug)
      }

      notify.show('‚úÖ Mua kh√≥a h·ªçc th√†nh c√¥ng! Gi·ªù b·∫°n c√≥ th·ªÉ h·ªçc to√†n b·ªô b√†i.', 'success')
    }
  }
}
</script>

<style scoped>
/* ======================================= */
/* üé® PH·∫¶N 4: CSS TRANG CHI TI·∫æT KH√ìA H·ªåC */
/* ======================================= */
/* (Ch∆∞a th√™m style ri√™ng, b·∫°n c√≥ th·ªÉ b·ªï sung sau n·∫øu c·∫ßn) */
</style>
